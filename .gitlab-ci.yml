image: ubuntu:24.04

services:
  - name: postgres:16
    alias: postgres
  - name: rabbitmq:3.12
    alias: rabbitmq

variables:
  POSTGRES_DB: test_db
  POSTGRES_USER: user
  POSTGRES_PASSWORD: password
  DB_HOST: postgres
  DB_NAME: test_db
  DB_USER: user
  DB_PASSWORD: password
  DB_PORT: 5432
  DB_ENGINE: django.db.backends.postgresql
  CELERY_BROKER_USER: guest
  CELERY_BROKER_PASSWORD: guest
  CELERY_BROKER_VHOST: ""
  CELERY_BROKER_HOST: rabbitmq

stages:
  - build

before_script:
  - apt-get update && apt-get -y install python3-virtualenv python3-psycopg

cache:
  paths:
    - .env

build:
  stage: build
  script:
    - ./setup.sh dev
    - env/bin/celery -A boxes worker -l info &
    - ci/monitor-celery.sh
