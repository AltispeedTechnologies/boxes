{% block content %}
    {% if page_obj %}
        {% include "_paginate.html" %}

        <div class="table-responsive mt-3">
            <table class="table table-bordered" style="user-select: none">
                <thead class="thead-dark">
                    <tr>
                        {% if checkout %}
                        <th></th>
                        {% endif %}
                        <th>Account</th>
                        <th>Tracking Code</th>
                        <th>Price</th>
                        <th>Carrier</th>
                        <th>Type</th>
                        <th>Type Description</th>
                        <th>Comments</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for package in page_obj %}
                    <tr>
                        {% if checkout %}
                        <td>
                            <input class="form-check-input package-checkbox"
                                   type="checkbox"
                                   value=""
                                   id="package-{{ package.id }}"
                                   {% if package.id|stringformat:"s" in selected %}
                                       checked
                                   {% endif %}>
                        </td>
                        {% endif %}
                        <td>{{ package.account__description }}</td>
                        <td><a href="/packages/{{ package.id }}">{{ package.tracking_code }}</a></td>
                        <td>${{ package.price }}</td>
                        <td>{{ package.carrier__name }}</td>
                        <td>{{ package.package_type__shortcode }}</td>
                        <td>{{ package.package_type__description }}</td>
                        <td>{{ package.comments }}</td>
                        <td><button class="btn btn-sm btn-primary">View</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="mt-3">No packages found.</p>
    {% endif %}
    <script>
        $(document).ready(function() {
            let selected_packages = new Set({{ selected|safe }});
            if (selected_packages.size > 0) { update_pagination_links(); }

            let last_checked = null;

            // Directly attaching the event listener to ensure it"s registered immediately
            $(document).on("click", ".package-checkbox", function(e) {
                let package_id = this.id.split("-")[1];
                
                // Check for the first click with a more reliable condition
                if (!last_checked) {
                    last_checked = this;
                    update_package_selection(this.checked, package_id);
                    return;
                }

                if (e.shiftKey && last_checked) {
                    handle_shift_select(this, last_checked);
                } else {
                    update_package_selection(this.checked, package_id);
                }

                last_checked = this;
            });

            function update_pagination_links() {
                // Convert the Set to a comma-separated string
                let selected_ids_str = Array.from(selected_packages).join(",");

                // Update each pagination link with the selected_ids parameter
                document.querySelectorAll(".pagination .page-link").forEach(link => {
                    let url = new URL(link.href, window.location.origin);
                    url.searchParams.set("selected_ids", selected_ids_str);
                    link.href = url.toString();
                });
            }

            function handle_shift_select(current, last) {
                let start = $(".package-checkbox").index(current);
                let end = $(".package-checkbox").index(last);
                $(".package-checkbox").slice(Math.min(start, end), Math.max(start, end) + 1).each(function() {
                    this.checked = last.checked;
                    update_package_selection(this.checked, this.id.split("-")[1]);
                });
            }

            function update_package_selection(is_checked, package_id) {
                if (is_checked) {
                    selected_packages.add(package_id);
                } else {
                    selected_packages.delete(package_id);
                }

                update_pagination_links();
            }

            function get_cookie(name) {
                var cookie_value = null;
                if (document.cookie && document.cookie !== "") {
                    var cookies = document.cookie.split(";");
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + "=")) {
                            cookie_value = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookie_value;
            }

            $("#checkoutbtn").click(function(event) {
                event.preventDefault();
                let csrfToken = get_cookie("csrftoken");
                let packagesArray = Array.from(selected_packages);
                let packagesPayload = {"ids": packagesArray};

                $.ajax({
                    type: "POST",
                    url: "/packages/checkout",
                    headers: {"X-CSRFToken": csrfToken},
                    data: packagesPayload,
                    success: function(response) {
                        if (response.success) {
                            window.location.href = response.redirect_url;
                        } else {
                            console.error("Checkout failed:", response.errors.join("; "));
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("An error occurred:", error);
                    }
                });
            });
        });
    </script>
{% endblock %}
